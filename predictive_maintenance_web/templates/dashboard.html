<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictive Maintenance Dashboard - UFD Flow Meters</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .status-healthy { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .status-critical { color: #6f42c1; }
        .metric-card {
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            display: none;
        }
        .tab-content {
            padding: 20px 0;
        }
        .maintenance-item {
            border-left: 4px solid;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .urgency-low { border-left-color: #28a745; background-color: #d4edda; }
        .urgency-medium { border-left-color: #ffc107; background-color: #fff3cd; }
        .urgency-high { border-left-color: #fd7e14; background-color: #ffeaa7; }
        .urgency-critical { border-left-color: #dc3545; background-color: #f8d7da; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-cogs"></i> Predictive Maintenance Dashboard
            </span>
            <div class="d-flex">
                <button class="btn btn-outline-light" onclick="loadData()">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-tachometer-alt"></i> System Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="overview-metrics">
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary" id="total-meters">-</h3>
                                        <p class="mb-0">Active Meters</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body text-center">
                                        <h3 class="text-success" id="healthy-meters">-</h3>
                                        <p class="mb-0">Healthy</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body text-center">
                                        <h3 class="text-warning" id="warning-meters">-</h3>
                                        <p class="mb-0">Need Attention</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card metric-card">
                                    <div class="card-body text-center">
                                        <h3 class="text-danger" id="critical-meters">-</h3>
                                        <p class="mb-0">Critical</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="processing-tab" data-bs-toggle="tab" data-bs-target="#processing" type="button">
                            <i class="fas fa-bolt"></i> Processing Speeds
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button">
                            <i class="fas fa-wrench"></i> Maintenance Schedule
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="predict-tab" data-bs-toggle="tab" data-bs-target="#predict" type="button">
                            <i class="fas fa-crystal-ball"></i> Live Prediction
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="mainTabContent">
                    <!-- Processing Speeds Tab -->
                    <div class="tab-pane fade show active" id="processing" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Flow Processing Requirements</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="flow-speed-chart"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Sound Speed Processing</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sound-speed-chart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Processing Speed Recommendations</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="processing-recommendations"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Maintenance Schedule Tab -->
                    <div class="tab-pane fade" id="maintenance" role="tabpanel">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Select Meter</h5>
                                    </div>
                                    <div class="card-body">
                                        <select class="form-select" id="meter-select" onchange="loadMaintenanceSchedule()">
                                            <option value="A">Meter A</option>
                                            <option value="B">Meter B</option>
                                            <option value="C">Meter C</option>
                                            <option value="D">Meter D</option>
                                        </select>
                                        <div class="mt-3">
                                            <label for="days-ahead" class="form-label">Days Ahead:</label>
                                            <input type="number" class="form-control" id="days-ahead" value="30" min="1" max="90" onchange="loadMaintenanceSchedule()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Maintenance Timeline</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="maintenance-timeline"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Upcoming Maintenance Events</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="maintenance-events"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div class="tab-pane fade" id="analytics" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Health State Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="health-distribution-chart"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Feature Importance</h5>
                                    </div>
                                    <div class="card-body">
                                        <select class="form-select mb-3" id="feature-meter-select" onchange="loadFeatureImportance()">
                                            <option value="A">Meter A</option>
                                            <option value="B">Meter B</option>
                                            <option value="C">Meter C</option>
                                            <option value="D">Meter D</option>
                                        </select>
                                        <div id="feature-importance-chart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Prediction Tab -->
                    <div class="tab-pane fade" id="predict" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Input Sensor Data</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="prediction-form">
                                            <div class="mb-3">
                                                <label for="pred-meter" class="form-label">Meter:</label>
                                                <select class="form-select" id="pred-meter">
                                                    <option value="A">Meter A</option>
                                                    <option value="B">Meter B</option>
                                                    <option value="C">Meter C</option>
                                                    <option value="D">Meter D</option>
                                                </select>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="flatness_ratio" class="form-label">Flatness Ratio:</label>
                                                        <input type="number" class="form-control" id="flatness_ratio" step="0.001" value="0.82">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="symmetry" class="form-label">Symmetry:</label>
                                                        <input type="number" class="form-control" id="symmetry" step="0.001" value="1.01">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="crossflow" class="form-label">Crossflow:</label>
                                                        <input type="number" class="form-control" id="crossflow" step="0.001" value="0.997">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="flow_velocity_1" class="form-label">Flow Velocity 1:</label>
                                                        <input type="number" class="form-control" id="flow_velocity_1" step="0.1" value="5.5">
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-primary w-100" onclick="makePrediction()">
                                                <i class="fas fa-magic"></i> Predict Health State
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Prediction Result</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="prediction-result">
                                            <p class="text-muted text-center">Enter sensor values and click predict to see results.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Processing data and training models...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let loadingModal;
        let processingSpeeds = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadData();
        });

        async function loadData() {
            loadingModal.show();
            
            try {
                const response = await fetch('/api/load_data');
                const data = await response.json();
                
                if (data.status === 'success') {
                    processingSpeeds = data.processing_speeds;
                    updateOverview();
                    loadProcessingSpeeds();
                    loadHealthDistribution();
                    loadMaintenanceSchedule();
                    loadFeatureImportance();
                } else {
                    alert('Error loading data: ' + data.message);
                }
            } catch (error) {
                alert('Error loading data: ' + error.message);
            } finally {
                loadingModal.hide();
            }
        }

        function updateOverview() {
            document.getElementById('total-meters').textContent = '4';
            document.getElementById('healthy-meters').textContent = '2';
            document.getElementById('warning-meters').textContent = '1';
            document.getElementById('critical-meters').textContent = '1';
        }

        async function loadProcessingSpeeds() {
            try {
                const response = await fetch('/api/processing_speeds');
                const data = await response.json();
                
                // Flow Speed Chart
                const flowData = Object.entries(data).map(([meter, speeds]) => ({
                    x: [`Meter ${meter}`],
                    y: [speeds.avg_flow_velocity],
                    name: `Meter ${meter}`,
                    type: 'bar'
                }));
                
                Plotly.newPlot('flow-speed-chart', flowData, {
                    title: 'Average Flow Velocities',
                    xaxis: { title: 'Meter' },
                    yaxis: { title: 'Flow Velocity (m/s)' }
                });

                // Sound Speed Chart
                const soundData = Object.entries(data).map(([meter, speeds]) => ({
                    x: [`Meter ${meter}`],
                    y: [speeds.avg_sound_speed],
                    name: `Meter ${meter}`,
                    type: 'bar'
                }));
                
                Plotly.newPlot('sound-speed-chart', soundData, {
                    title: 'Average Sound Speeds',
                    xaxis: { title: 'Meter' },
                    yaxis: { title: 'Sound Speed (m/s)' }
                });

                // Processing Recommendations
                let recommendations = '<div class="row">';
                Object.entries(data).forEach(([meter, speeds]) => {
                    const optimalMin = speeds.optimal_range[0];
                    const optimalMax = speeds.optimal_range[1];
                    recommendations += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6><i class="fas fa-microchip"></i> Meter ${meter} Processing</h6>
                                    <p><strong>Optimal Flow Range:</strong> ${optimalMin.toFixed(2)} - ${optimalMax.toFixed(2)} m/s</p>
                                    <p><strong>Recommended Sampling:</strong> ${Math.round(speeds.avg_sound_speed / 100)} Hz</p>
                                    <p><strong>Processing Load:</strong> ${speeds.flow_std > 1 ? 'High' : 'Normal'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                recommendations += '</div>';
                document.getElementById('processing-recommendations').innerHTML = recommendations;
                
            } catch (error) {
                console.error('Error loading processing speeds:', error);
            }
        }

        async function loadMaintenanceSchedule() {
            const meterId = document.getElementById('meter-select').value;
            const daysAhead = document.getElementById('days-ahead').value;
            
            try {
                const response = await fetch(`/api/maintenance_schedule/${meterId}?days=${daysAhead}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const schedule = data.schedule;
                    
                    // Timeline Chart
                    const timelineData = [{
                        x: schedule.map(item => item.date),
                        y: schedule.map(item => item.predicted_state),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Predicted Health State',
                        line: { color: '#667eea' }
                    }];
                    
                    Plotly.newPlot('maintenance-timeline', timelineData, {
                        title: `Meter ${meterId} - Predicted Health Progression`,
                        xaxis: { title: 'Date' },
                        yaxis: { title: 'Health State', range: [0.5, 4.5] }
                    });

                    // Maintenance Events
                    let eventsHtml = '';
                    const maintenanceEvents = schedule.filter(item => item.maintenance_needed);
                    
                    if (maintenanceEvents.length === 0) {
                        eventsHtml = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> No maintenance required in the selected timeframe.</div>';
                    } else {
                        maintenanceEvents.forEach(event => {
                            const urgencyClass = `urgency-${event.urgency.toLowerCase()}`;
                            eventsHtml += `
                                <div class="maintenance-item ${urgencyClass}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${event.date}</strong> (Day ${event.day})
                                            <br>
                                            <small>Predicted State: ${event.predicted_state} | Confidence: ${(event.confidence * 100).toFixed(1)}%</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-${event.urgency === 'Critical' ? 'danger' : event.urgency === 'High' ? 'warning' : 'info'}">
                                                ${event.urgency} Priority
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    document.getElementById('maintenance-events').innerHTML = eventsHtml;
                }
            } catch (error) {
                console.error('Error loading maintenance schedule:', error);
            }
        }

        async function loadHealthDistribution() {
            try {
                const response = await fetch('/api/health_distribution');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const distributions = data.distributions;
                    
                    const chartData = Object.entries(distributions).map(([meter, dist]) => ({
                        labels: Object.keys(dist).map(state => `State ${state}`),
                        values: Object.values(dist),
                        name: `Meter ${meter}`,
                        type: 'pie',
                        domain: {
                            row: meter === 'A' || meter === 'B' ? 0 : 1,
                            column: meter === 'A' || meter === 'C' ? 0 : 1
                        },
                        title: `Meter ${meter}`
                    }));

                    Plotly.newPlot('health-distribution-chart', chartData, {
                        title: 'Health State Distributions Across All Meters',
                        grid: { rows: 2, columns: 2 }
                    });
                }
            } catch (error) {
                console.error('Error loading health distribution:', error);
            }
        }

        async function loadFeatureImportance() {
            const meterId = document.getElementById('feature-meter-select').value;
            
            try {
                const response = await fetch(`/api/feature_importance/${meterId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const importance = data.feature_importance;
                    
                    const chartData = [{
                        x: Object.values(importance),
                        y: Object.keys(importance),
                        type: 'bar',
                        orientation: 'h',
                        marker: { color: '#667eea' }
                    }];
                    
                    Plotly.newPlot('feature-importance-chart', chartData, {
                        title: `Top Features - Meter ${meterId}`,
                        xaxis: { title: 'Importance Score' },
                        yaxis: { title: 'Features' },
                        height: 400
                    });
                }
            } catch (error) {
                console.error('Error loading feature importance:', error);
            }
        }

        async function makePrediction() {
            const sensorData = {
                meter_id: document.getElementById('pred-meter').value,
                sensor_data: {
                    flatness_ratio: parseFloat(document.getElementById('flatness_ratio').value),
                    symmetry: parseFloat(document.getElementById('symmetry').value),
                    crossflow: parseFloat(document.getElementById('crossflow').value),
                    flow_velocity_1: parseFloat(document.getElementById('flow_velocity_1').value)
                }
            };

            try {
                const response = await fetch('/api/predict_single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sensorData)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const prediction = data.prediction;
                    const healthState = prediction.health_state;
                    const confidence = (prediction.confidence * 100).toFixed(1);
                    
                    let statusColor = 'success';
                    let statusIcon = 'check-circle';
                    let statusText = 'Healthy';
                    
                    if (healthState >= 4) {
                        statusColor = 'danger';
                        statusIcon = 'exclamation-triangle';
                        statusText = 'Critical';
                    } else if (healthState >= 3) {
                        statusColor = 'warning';
                        statusIcon = 'exclamation-circle';
                        statusText = 'Needs Attention';
                    } else if (healthState >= 2) {
                        statusColor = 'info';
                        statusIcon = 'info-circle';
                        statusText = 'Monitor';
                    }
                    
                    const resultHtml = `
                        <div class="alert alert-${statusColor}">
                            <h5><i class="fas fa-${statusIcon}"></i> ${statusText}</h5>
                            <p><strong>Predicted Health State:</strong> ${healthState}</p>
                            <p><strong>Confidence:</strong> ${confidence}%</p>
                            <p><strong>Maintenance Recommended:</strong> ${prediction.maintenance_recommended ? 'Yes' : 'No'}</p>
                        </div>
                        <div class="mt-3">
                            <h6>State Probabilities:</h6>
                            ${prediction.probabilities.map((prob, index) => 
                                `<div class="progress mb-2">
                                    <div class="progress-bar" style="width: ${(prob * 100).toFixed(1)}%">
                                        State ${index + 1}: ${(prob * 100).toFixed(1)}%
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    `;
                    
                    document.getElementById('prediction-result').innerHTML = resultHtml;
                } else {
                    document.getElementById('prediction-result').innerHTML = 
                        `<div class="alert alert-danger">Error: ${data.message}</div>`;
                }
            } catch (error) {
                document.getElementById('prediction-result').innerHTML = 
                    `<div class="alert alert-danger">Error making prediction: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>