<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Projections - EcoPulse Energy Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --aramco-green: #84BD00;
            --aramco-dark-green: #00843D;
            --aramco-blue: #00A3E0;
            --aramco-dark-blue: #0033A0;
            --aramco-white: #FFFFFF;
            --aramco-dark-gray: #323232;
        }
        
        body {
            background: linear-gradient(135deg, #FFFFFF 0%, #F8F9FA 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--aramco-dark-gray);
        }
        
        .navbar {
            background: var(--aramco-white) !important;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--aramco-blue);
        }
        
        .btn-outline-light {
            color: var(--aramco-blue) !important;
            border-color: var(--aramco-blue) !important;
            font-weight: bold;
        }
        
        .btn-outline-light:hover {
            background-color: var(--aramco-blue) !important;
            border-color: var(--aramco-blue) !important;
            color: white !important;
        }
        
        .card {
            background: var(--aramco-white);
            backdrop-filter: blur(10px);
            border: 2px solid var(--aramco-blue);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 163, 224, 0.1);
            transition: all 0.3s ease;
            color: var(--aramco-dark-gray);
        }
        
        .projection-metric {
            text-align: center;
            padding: 1.5rem;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(132, 189, 0, 0.1), rgba(0, 163, 224, 0.1));
            border: 1px solid var(--aramco-green);
            transition: all 0.3s ease;
        }
        
        .projection-metric:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--aramco-green);
        }
        
        .text-muted {
            color: #6C757D !important;
        }
        
        .chart-container {
            height: 400px;
            border-radius: 15px;
        }
        
        .timeline-item {
            border-left: 3px solid var(--aramco-blue);
            padding-left: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--aramco-blue);
        }
        
        .timeline-date {
            font-weight: 600;
            color: var(--aramco-blue);
            font-size: 0.9rem;
        }
        
        .cost-breakdown {
            background: rgba(0, 132, 61, 0.1);
            border-left: 4px solid var(--aramco-dark-green);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .recommendation-item {
            background: rgba(132, 189, 0, 0.1);
            border: 1px solid rgba(132, 189, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
        }
        
        .recommendation-item:hover {
            background: rgba(132, 189, 0, 0.2);
            transform: translateX(5px);
        }
        
        .projection-controls {
            background: var(--aramco-white);
            border: 2px solid var(--aramco-blue);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: var(--aramco-dark-gray);
        }
        
        .form-select, .form-control {
            background-color: var(--aramco-white);
            border-color: var(--aramco-blue);
            color: var(--aramco-dark-gray);
        }
        
        .form-select:focus, .form-control:focus {
            background-color: var(--aramco-white);
            border-color: var(--aramco-green);
            color: var(--aramco-dark-gray);
            box-shadow: 0 0 0 0.25rem rgba(132, 189, 0, 0.25);
        }
        
        .energy-bar {
            height: 40px;
            background: linear-gradient(90deg, var(--aramco-dark-gray) 0%, #2C2C2C 100%);
            border-radius: 20px;
            position: relative;
            margin: 1rem 0;
        }
        
        .energy-level {
            height: 100%;
            background: linear-gradient(90deg, var(--aramco-green) 0%, var(--aramco-blue) 50%, var(--aramco-dark-green) 100%);
            border-radius: 20px;
            transition: width 1.5s ease-in-out;
            position: relative;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top">
        <div class="container-fluid">
            <a href="/" class="navbar-brand">
                <i class="fas fa-leaf"></i> EcoPulse - Future Projections
            </a>
            <div class="d-flex">
                <a href="/" class="btn btn-outline-light me-2">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="/current-status" class="btn btn-outline-light">
                    <i class="fas fa-tachometer-alt"></i> Current Status
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Controls -->
        <div class="row">
            <div class="col-12">
                <div class="projection-controls">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label for="projection-period" class="form-label">Projection Period:</label>
                            <select class="form-select" id="projection-period" onchange="loadProjections()">
                                <option value="30">30 Days</option>
                                <option value="90" selected>90 Days</option>
                                <option value="180">6 Months</option>
                                <option value="365">1 Year</option>
                                <option value="1825">5 Years</option>
                                <option value="9125">25 Years (Until 2050)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="scenario-type" class="form-label">Scenario:</label>
                            <select class="form-select" id="scenario-type" onchange="loadProjections()">
                                <option value="current">Current Trajectory</option>
                                <option value="optimistic">Optimistic</option>
                                <option value="pessimistic">Pessimistic</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projected Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="projection-metric">
                    <div class="metric-value" id="projected-power">--</div>
                    <h6 class="mt-2">Projected Power</h6>
                    <small class="text-muted">Average for period</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="projection-metric">
                    <div class="metric-value" id="projected-clean">--</div>
                    <h6 class="mt-2">Clean Energy</h6>
                    <small class="text-muted">Improvement potential</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="projection-metric">
                    <div class="metric-value" id="projected-netzero">--</div>
                    <h6 class="mt-2">Net Zero Progress</h6>
                    <small class="text-muted">Target achievement</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="projection-metric">
                    <div class="metric-value" id="total-cost">--</div>
                    <h6 class="mt-2">Total Investment</h6>
                    <small class="text-muted">Estimated costs</small>
                </div>
            </div>
        </div>

        <!-- Main Projection Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line text-primary"></i>
                            Performance Projection Timeline
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="projection-timeline-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Implementation Timeline and Costs -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks text-success"></i>
                            Implementation Timeline
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="implementation-timeline">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading implementation timeline...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="fas fa-dollar-sign text-warning"></i>
                            Cost Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="cost-breakdown">
                            <div class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading cost analysis...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Power Output -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt" style="color: var(--aramco-green);"></i>
                            Current Power Output
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-2">Total Energy Output: <span id="current-total-output" class="text-white">--</span> MW</h6>
                                <div class="energy-bar">
                                    <div id="current-energy-level" class="energy-level" style="width: 0%">
                                        <div class="position-absolute top-50 start-50 translate-middle text-white fw-bold">
                                            <span id="current-percentage">--</span>%
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-3 text-center">
                                        <small class="text-white">Solar</small><br>
                                        <strong id="solar-current" class="text-white">--</strong> MW
                                    </div>
                                    <div class="col-3 text-center">
                                        <small class="text-white">Wind</small><br>
                                        <strong id="wind-current" class="text-white">--</strong> MW
                                    </div>
                                    <div class="col-3 text-center">
                                        <small class="text-white">Hydro</small><br>
                                        <strong id="hydro-current" class="text-white">--</strong> MW
                                    </div>
                                    <div class="col-3 text-center">
                                        <small class="text-white">Gas</small><br>
                                        <strong id="gas-current" class="text-white">--</strong> MW
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div id="power-output-gauge" class="chart-container" style="height: 250px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb" style="color: var(--aramco-green);"></i>
                            AI-Powered Recommendations
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recommendations-container">
                            <div class="text-center">
                                <div class="spinner-border" style="color: var(--aramco-blue);" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-white">Analyzing patterns and generating recommendations...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let projectionData = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadProjections();
            loadCurrentPowerOutput();
        });

        async function loadCurrentPowerOutput() {
            try {
                const response = await fetch('/api/energy_sources');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const energySources = data.energy_sources;
                    const totalOutput = Object.values(energySources).reduce((sum, source) => sum + source.current, 0);
                    const maxCapacity = 300; // Maximum total capacity
                    
                    document.getElementById('current-total-output').textContent = totalOutput.toFixed(1);
                    const percentage = Math.round((totalOutput / maxCapacity) * 100);
                    document.getElementById('current-percentage').textContent = percentage;
                    document.getElementById('current-energy-level').style.width = Math.min(percentage, 100) + '%';
                    
                    // Update individual sources
                    document.getElementById('solar-current').textContent = energySources.solar.current;
                    document.getElementById('wind-current').textContent = energySources.wind.current;
                    document.getElementById('hydro-current').textContent = energySources.hydro.current;
                    document.getElementById('gas-current').textContent = energySources.oil_gas.current;
                    
                    // Create enhanced gauge chart
                    createPowerOutputGauge(totalOutput, percentage);
                }
            } catch (error) {
                console.error('Error loading current power output:', error);
                // Fallback data
                document.getElementById('current-total-output').textContent = '100.0';
                document.getElementById('current-percentage').textContent = '75';
                document.getElementById('current-energy-level').style.width = '75%';
                createPowerOutputGauge(100, 75);
            }
        }
        
        function createPowerOutputGauge(currentOutput, percentage = null) {
            if (percentage === null) {
                percentage = Math.round((currentOutput / 300) * 100);
            }
            
            const data = [{
                type: 'indicator',
                mode: 'gauge+number+delta',
                value: currentOutput,
                domain: { x: [0, 1], y: [0, 1] },
                title: { text: 'MW Output', font: { color: '#323232', size: 14, weight: 'bold' } },
                delta: { reference: 250, increasing: { color: '#84BD00' } },
                gauge: {
                    axis: { range: [null, 300], tickcolor: '#323232', tickfont: { color: '#323232', weight: 'bold' } },
                    bar: { color: '#00A3E0', thickness: 0.8 },
                    bgcolor: 'rgba(248,249,250,0.8)',
                    borderwidth: 3,
                    bordercolor: '#84BD00',
                    steps: [
                        { range: [0, 150], color: 'rgba(132,189,0,0.2)' },
                        { range: [150, 250], color: 'rgba(0,163,224,0.5)' },
                        { range: [250, 300], color: 'rgba(0,132,61,0.8)' }
                    ],
                    threshold: {
                        line: { color: '#323232', width: 4 },
                        thickness: 0.75,
                        value: 280
                    }
                }
            }];
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#323232', size: 12 },
                margin: { t: 40, r: 25, l: 25, b: 25 }
            };
            
            Plotly.newPlot('power-output-gauge', data, layout, {displayModeBar: false, responsive: true});
        }
        
        async function loadProjections() {
            try {
                const days = document.getElementById('projection-period').value;
                const scenario = document.getElementById('scenario-type').value;
                
                const response = await fetch(`/api/future_projections?days=${days}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    projectionData = data.projections;
                    
                    // Apply scenario adjustments
                    let adjustedData = adjustForScenario(projectionData, scenario);
                    
                    updateProjectedMetrics(data.improvement_potential, data.total_estimated_cost);
                    createProjectionChart(adjustedData);
                    createImplementationTimeline(adjustedData.slice(0, 30)); // First 30 days
                    createCostBreakdown(data.total_estimated_cost);
                    generateRecommendations(adjustedData);
                }
            } catch (error) {
                console.error('Error loading projections:', error);
            }
        }

        function adjustForScenario(data, scenario) {
            const multipliers = {
                'current': { power: 1.0, clean: 1.0, netzero: 1.0, cost: 1.0 },
                'optimistic': { power: 1.15, clean: 1.25, netzero: 1.20, cost: 0.85 },
                'pessimistic': { power: 0.85, clean: 0.80, netzero: 0.75, cost: 1.25 }
            };
            
            const mult = multipliers[scenario];
            
            return data.map(item => ({
                ...item,
                predicted_power: Math.round(item.predicted_power * mult.power * 10) / 10,
                predicted_clean: Math.round(item.predicted_clean * mult.clean * 10) / 10,
                predicted_net_zero: Math.round(item.predicted_net_zero * mult.netzero * 10) / 10,
                estimated_cost: Math.round(item.estimated_cost * mult.cost)
            }));
        }

        function updateProjectedMetrics(improvement, totalCost) {
            document.getElementById('projected-power').textContent = improvement.power + ' MW';
            document.getElementById('projected-clean').textContent = improvement.clean + '%';
            document.getElementById('projected-netzero').textContent = improvement.net_zero + '%';
            document.getElementById('total-cost').textContent = '$' + (totalCost / 1000).toFixed(0) + 'K';
        }

        function createProjectionChart(data) {
            const dates = data.map(d => d.date);
            
            const chartData = [
                {
                    x: dates,
                    y: data.map(d => d.predicted_power),
                    name: 'Power Generation (MW)',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#84BD00', width: 3 },
                    marker: { color: '#84BD00', size: 6 }
                },
                {
                    x: dates,
                    y: data.map(d => d.predicted_clean),
                    name: 'Clean Energy %',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#00A3E0', width: 3 },
                    marker: { color: '#00A3E0', size: 6 }
                },
                {
                    x: dates,
                    y: data.map(d => d.predicted_net_zero),
                    name: 'Net Zero Score %',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#00843D', width: 3 },
                    marker: { color: '#00843D', size: 6 }
                }
            ];

            const layout = {
                title: {
                    text: 'Future Performance Projections',
                    font: { color: '#323232', size: 18 }
                },
                xaxis: { 
                    title: { text: 'Date', font: { color: '#323232' } },
                    showgrid: true,
                    gridcolor: 'rgba(132,189,0,0.3)',
                    tickfont: { color: '#323232' }
                },
                yaxis: { 
                    title: { text: 'Performance Metrics', font: { color: '#323232' } },
                    showgrid: true,
                    gridcolor: 'rgba(0,163,224,0.3)',
                    tickfont: { color: '#323232' }
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(248,249,250,0.5)',
                hovermode: 'x unified',
                legend: {
                    orientation: 'h',
                    y: -0.2,
                    font: { color: '#323232' }
                }
            };

            Plotly.newPlot('projection-timeline-chart', chartData, layout, {responsive: true});
        }

        function createImplementationTimeline(data) {
            const container = document.getElementById('implementation-timeline');
            let html = '';

            // Group data by weeks for timeline
            const weeks = [];
            for (let i = 0; i < data.length; i += 7) {
                const weekData = data.slice(i, i + 7);
                const weekAvg = {
                    start_date: weekData[0].date,
                    end_date: weekData[weekData.length - 1].date,
                    avg_power: weekData.reduce((sum, d) => sum + d.predicted_power, 0) / weekData.length,
                    avg_clean: weekData.reduce((sum, d) => sum + d.predicted_clean, 0) / weekData.length,
                    total_cost: weekData.reduce((sum, d) => sum + d.estimated_cost, 0),
                    actions: weekData[0].recommended_actions || []
                };
                weeks.push(weekAvg);
            }

            weeks.forEach((week, index) => {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-date">
                            Week ${index + 1}: ${week.start_date} - ${week.end_date}
                        </div>
                        <h6 class="mt-2">Projected Improvements</h6>
                        <p class="mb-2">
                            <strong>Power:</strong> ${week.avg_power.toFixed(1)} MW |
                            <strong>Clean Energy:</strong> ${week.avg_clean.toFixed(1)}% |
                            <strong>Cost:</strong> $${week.total_cost.toLocaleString()}
                        </p>
                        <div class="recommended-actions">
                            <small class="text-muted">Recommended Actions:</small>
                            <ul class="mt-1">
                                ${week.actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function createCostBreakdown(totalCost) {
            const container = document.getElementById('cost-breakdown');
            
            // Simulate cost breakdown
            const breakdown = {
                'Infrastructure': Math.round(totalCost * 0.40),
                'Maintenance': Math.round(totalCost * 0.25),
                'Technology': Math.round(totalCost * 0.20),
                'Operations': Math.round(totalCost * 0.15)
            };

            let html = '<h6 class="mb-3">Investment Breakdown</h6>';
            
            Object.entries(breakdown).forEach(([category, amount]) => {
                const percentage = Math.round((amount / totalCost) * 100);
                html += `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${category}:</span>
                        <div class="text-end">
                            <strong>$${amount.toLocaleString()}</strong>
                            <small class="text-muted">(${percentage}%)</small>
                        </div>
                    </div>
                `;
            });

            html += `
                <hr>
                <div class="cost-breakdown">
                    <div class="d-flex justify-content-between">
                        <strong>Total Investment:</strong>
                        <strong>$${totalCost.toLocaleString()}</strong>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Estimated ROI: 18-24 months based on efficiency gains
                    </small>
                </div>
            `;

            container.innerHTML = html;
        }

        function generateRecommendations(data) {
            const container = document.getElementById('recommendations-container');
            
            // Analyze data to generate smart recommendations
            const avgClean = data.reduce((sum, d) => sum + d.predicted_clean, 0) / data.length;
            const avgPower = data.reduce((sum, d) => sum + d.predicted_power, 0) / data.length;
            const totalCost = data.reduce((sum, d) => sum + d.estimated_cost, 0);

            const recommendations = [
                {
                    title: 'Solar Panel Optimization',
                    description: 'Clean energy potential shows room for improvement. Consider upgrading solar panel efficiency.',
                    priority: avgClean < 75 ? 'High' : 'Medium',
                    impact: 'Up to 15% increase in clean energy output',
                    cost: '$25,000 - $40,000'
                },
                {
                    title: 'Energy Storage Enhancement',
                    description: 'Battery storage optimization could improve overall system reliability.',
                    priority: avgPower < 850 ? 'High' : 'Low',
                    impact: 'Reduced energy waste by 8-12%',
                    cost: '$15,000 - $30,000'
                },
                {
                    title: 'Predictive Maintenance Schedule',
                    description: 'Implement AI-driven maintenance to prevent efficiency drops.',
                    priority: 'Medium',
                    impact: 'Prevent 5-10% efficiency loss',
                    cost: '$5,000 - $12,000'
                },
                {
                    title: 'Grid Integration Upgrade',
                    description: 'Enhanced grid connectivity for better energy distribution.',
                    priority: totalCost > 150000 ? 'Low' : 'High',
                    impact: 'Improved net zero progress by 20%',
                    cost: '$35,000 - $55,000'
                }
            ];

            let html = '';
            recommendations.forEach(rec => {
                const priorityColor = rec.priority === 'High' ? 'danger' : 
                                    rec.priority === 'Medium' ? 'warning' : 'success';
                
                html += `
                    <div class="recommendation-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">
                                    <i class="fas fa-lightbulb"></i> ${rec.title}
                                    <span class="badge bg-${priorityColor} ms-2">${rec.priority}</span>
                                </h6>
                                <p class="mb-2 text-muted">${rec.description}</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small><strong>Expected Impact:</strong> ${rec.impact}</small>
                                    </div>
                                    <div class="col-md-6">
                                        <small><strong>Investment Range:</strong> ${rec.cost}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Auto-refresh projections every 5 minutes
        setInterval(loadProjections, 300000);
    </script>
</body>
</html>