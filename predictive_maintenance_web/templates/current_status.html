<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Status - EcoPulse Energy Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --aramco-green: #84BD00;
            --aramco-dark-green: #00843D;
            --aramco-blue: #00A3E0;
            --aramco-dark-blue: #0033A0;
            --aramco-white: #FFFFFF;
            --aramco-dark-gray: #323232;
        }
        
        body {
            background: linear-gradient(135deg, #FFFFFF 0%, #F8F9FA 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--aramco-dark-gray);
        }
        
        .navbar {
            background: var(--aramco-white) !important;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--aramco-blue);
        }
        
        .navbar-brand, .navbar-brand:hover {
            color: var(--aramco-dark-gray) !important;
        }
        
        .btn-outline-light {
            color: var(--aramco-blue) !important;
            border-color: var(--aramco-blue) !important;
            font-weight: bold;
        }
        
        .btn-outline-light:hover {
            background-color: var(--aramco-blue) !important;
            border-color: var(--aramco-blue) !important;
            color: white !important;
        }
        
        .card {
            background: var(--aramco-white);
            backdrop-filter: blur(10px);
            border: 2px solid var(--aramco-blue);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 163, 224, 0.1);
            transition: all 0.3s ease;
            color: var(--aramco-dark-gray);
        }
        
        .card-header {
            border-bottom: 1px solid var(--aramco-blue);
            background: linear-gradient(135deg, rgba(132, 189, 0, 0.1), rgba(0, 163, 224, 0.1)) !important;
        }
        
        .energy-gauge {
            position: relative;
            width: 100%;
            height: 300px;
            margin: 30px 0;
        }
        
        .maintenance-toggle {
            background: linear-gradient(135deg, var(--aramco-green), var(--aramco-blue));
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1.5rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .maintenance-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .maintenance-item {
            border: 2px solid #E9ECEF;
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--aramco-white);
        }
        
        .maintenance-item:hover {
            box-shadow: 0 4px 12px rgba(0, 163, 224, 0.15);
            transform: translateY(-2px);
            border-color: var(--aramco-blue);
        }
        
        .maintenance-item.expanded {
            border-color: var(--aramco-blue);
            background: rgba(0, 163, 224, 0.05);
        }

        .maintenance-detail-item {
            background: var(--aramco-white);
            border: 2px solid #E9ECEF;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .maintenance-detail-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 163, 224, 0.15);
            border-color: var(--aramco-blue);
        }

        .maintenance-cost-highlight {
            background: linear-gradient(135deg, rgba(132, 189, 0, 0.1), rgba(0, 163, 224, 0.1));
            border: 2px solid var(--aramco-green);
            border-radius: 10px;
            padding: 1rem;
            margin: 0.75rem 0;
        }

        .maintenance-detail-item .btn-group .btn {
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
        }

        .maintenance-detail-item .btn-group .btn:hover {
            transform: translateY(-2px);
        }

        /* Collapsible maintenance items */
        .maintenance-item-collapsed {
            background: var(--aramco-white);
            border: 2px solid #E9ECEF;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .maintenance-item-collapsed:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 163, 224, 0.12);
            border-color: var(--aramco-blue);
        }

        .maintenance-item-collapsed.expanded {
            border-color: var(--aramco-blue);
            box-shadow: 0 6px 20px rgba(0, 163, 224, 0.2);
        }

        .maintenance-collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            padding: 0;
        }

        .maintenance-collapse-content.show {
            max-height: 500px;
            padding: 1rem 0 0 0;
        }

        .maintenance-header {
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .maintenance-toggle-icon {
            transition: transform 0.3s ease;
            color: var(--aramco-blue);
            font-size: 1.2rem;
        }

        .maintenance-toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .cost-preview {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--aramco-green);
        }
        
        /* Loading animations */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .energy-gauge, .chart-container {
            position: relative;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--aramco-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .urgency-critical { border-left: 4px solid #DC3545; }
        .urgency-high { border-left: 4px solid #FD7E14; }
        .urgency-medium { border-left: 4px solid #FFC107; }
        .urgency-low { border-left: 4px solid var(--aramco-green); }
        
        .chart-container {
            height: 350px;
            min-height: 250px;
        }
        
        .energy-bar {
            position: relative;
            height: 450px;
            width: 100px;
            background: #F8F9FA;
            border: 3px solid var(--aramco-blue);
            border-radius: 50px;
            margin: 30px auto 0;
            overflow: hidden;
        }
        
        .energy-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(0deg, var(--aramco-green) 0%, var(--aramco-blue) 50%, var(--aramco-dark-blue) 100%);
            border-radius: 47px;
            transition: height 1s ease;
        }
        
        .energy-percentage {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--aramco-dark-gray);
        }
        
        .collapse-content {
            background: rgba(132, 189, 0, 0.1);
            border: 1px solid rgba(132, 189, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .form-select {
            border-color: var(--aramco-blue);
            color: var(--aramco-dark-gray);
        }
        
        .form-select:focus {
            border-color: var(--aramco-green);
            box-shadow: 0 0 0 0.25rem rgba(132, 189, 0, 0.25);
        }
        
        .text-muted {
            color: #6C757D !important;
        }
    </style></head>
<body>
    <nav class="navbar navbar-dark sticky-top">
        <div class="container-fluid">
            <a href="/" class="navbar-brand">
                <i class="fas fa-leaf"></i> EcoPulse - Current Status
            </a>
            <div class="d-flex">
                <a href="/" class="btn btn-outline-light me-2">
                    <i class="fas fa-home"></i> Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-2">
        <div class="row">
            <!-- Left Side - Energy Bar -->
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header bg-transparent text-center">
                        <h5 class="mb-0">
                            <i class="fas fa-battery-three-quarters text-success"></i>
                            Energy Level
                        </h5>
                    </div>
                    <div class="card-body text-center" style="margin-top: 2rem;">
                        <div class="energy-gauge">
                            <div class="energy-bar">
                                <div class="energy-fill" id="energy-fill"></div>
                            </div>
                            <div class="energy-percentage" id="energy-percentage">0%</div>
                        </div>
                        <div class="text-center mt-4">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Charts Row -->
            <div class="col-md-9">
                <div class="row">
                    <!-- Energy Sources Chart -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie text-primary"></i>
                                    Energy Sources Distribution
                                </h5>
                            </div>
                            <div class="card-body d-flex justify-content-center align-items-center">
                                <div id="energy-sources-chart" class="chart-container" style="height: 600px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Usage History Chart -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-history text-info"></i>
                                    Usage History
                                </h5>
                                <select class="form-select form-select-sm w-auto" id="history-days" onchange="loadUsageHistory()" style="width: auto!important; min-width: 120px;">
                                    <option value="7">Last 7 Days</option>
                                    <option value="14">Last 14 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div id="usage-history-chart" class="chart-container" style="height: 350px;"></div>
                                <div id="history-summary" class="mt-3" style="display: none;">
                                    <h6 class="mb-2">Live Performance</h6>
                                    <div id="summary-stats"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-wrench text-warning"></i>
                            Maintenance Management
                            <span class="badge bg-warning ms-2" id="maintenance-count">Loading...</span>
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleMaintenanceView()">
                                <i class="fas fa-eye" id="toggle-icon"></i>
                                <span id="toggle-text">Show All</span>
                            </button>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="category-filter" onchange="filterMaintenance()">
                                <option value="all">All Priorities</option>
                                <option value="Critical">Critical Only</option>
                                <option value="High">High Only</option>
                                <option value="Medium">Medium Only</option>
                                <option value="Low">Low Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Performance Analysis Section -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="alert alert-warning border-warning">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-chart-line-down text-danger"></i>
                                        Performance Analysis Alert
                                    </h6>
                                    <p class="mb-2">AI monitoring has detected performance degradation patterns that require immediate attention based on historical training data.</p>
                                    <div id="performance-decline-chart" style="height: 200px; margin: 1rem 0;"></div>
                                    <div class="d-flex justify-content-between text-small">
                                        <span><strong>Expected Performance:</strong> <span class="text-success">92%</span></span>
                                        <span><strong>Current Performance:</strong> <span class="text-danger">78%</span></span>
                                        <span><strong>Decline Rate:</strong> <span class="text-warning">-2.3%/day</span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-light rounded">
                                    <h6 class="text-dark fw-bold">Maintenance Priority Distribution</h6>
                                    <div id="priority-distribution-chart" style="height: 330px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="maintenance-items-container" class="row g-3">
                            <div class="col-12 text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading maintenance data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalLabel">Update Maintenance Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Content will be dynamically updated -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let maintenanceData = [];
        let showAllMaintenance = false;
        let maintenanceUpdatesEnabled = false; // Keep maintenance static by default
        
        // Initialization flags to prevent re-animation on refresh
        let energyBarInitialized = false;
        let energySourcesInitialized = false;
        let usageHistoryInitialized = false;

        document.addEventListener('DOMContentLoaded', function() {
            // Load components with staggered timing for better visual effect
            loadCurrentStatusLive(); // Energy bar loads immediately
            
            setTimeout(() => {
                // Pie chart loads after 1 second
                if (window.energySourcesData) {
                    createEnergySourcesChart(window.energySourcesData);
                }
            }, 1000);
            
            setTimeout(() => {
                loadUsageHistory(); // Line chart loads after 2 seconds
            }, 2000);
            
            setTimeout(() => {
                loadMaintenanceItems(); // Maintenance items after 3 seconds
            }, 3000);
            
            // Initialize live data simulation
            lastUpdateTime = Date.now();
        });

        async function loadCurrentStatus() {
            try {
                const response = await fetch('/api/energy_sources');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateEnergyBar(data.total_power);
                    createEnergySourcesChart(data.energy_sources);
                }
            } catch (error) {
                console.error('Error loading current status:', error);
            }
        }

        function updateEnergyBar(percentage) {
            const fill = document.getElementById('energy-fill');
            const percentageText = document.getElementById('energy-percentage');
            
            // Determine color based on percentage
            let targetColor;
            if (percentage > 85) {
                targetColor = 'linear-gradient(0deg, #28a745 0%, #84BD00 50%, #00A3E0 100%)';
            } else if (percentage > 70) {
                targetColor = 'linear-gradient(0deg, #ffc107 0%, #84BD00 50%, #00A3E0 100%)';
            } else {
                targetColor = 'linear-gradient(0deg, #dc3545 0%, #fd7e14 50%, #ffc107 100%)';
            }
            
            if (!energyBarInitialized) {
                // First load - animate from 0
                fill.style.height = '0%';
                percentageText.textContent = '0%';
                
                // Animate the energy bar filling up
                const steps = 50;
                let currentStep = 0;
                
                const animateBar = () => {
                    currentStep++;
                    const progress = currentStep / steps;
                    const currentValue = percentage * progress;
                    
                    fill.style.height = currentValue + '%';
                    percentageText.textContent = Math.round(currentValue) + '%';
                    fill.style.background = targetColor;
                    
                    // Add pulsing effect during animation
                    percentageText.style.transform = 'translateX(-50%) scale(' + (1 + 0.1 * Math.sin(progress * Math.PI)) + ')';
                    
                    if (currentStep < steps) {
                        setTimeout(animateBar, 60); // 60ms per step = ~3 second total animation
                    } else {
                        // Final state - remove pulsing and mark as initialized
                        percentageText.style.transform = 'translateX(-50%) scale(1)';
                        energyBarInitialized = true;
                    }
                };
                
                // Start animation after a short delay
                setTimeout(animateBar, 200);
            } else {
                // Subsequent updates - smooth transition without full animation
                fill.style.transition = 'height 0.8s ease-in-out';
                percentageText.style.transition = 'all 0.3s ease';
                
                fill.style.height = percentage + '%';
                percentageText.textContent = percentage + '%';
                fill.style.background = targetColor;
                
                // Brief highlight effect for updates
                percentageText.style.transform = 'translateX(-50%) scale(1.05)';
                setTimeout(() => {
                    percentageText.style.transform = 'translateX(-50%) scale(1)';
                }, 200);
            }
        }

        function createEnergySourcesChart(sources) {
            const sourceNames = Object.keys(sources);
            const targetValues = sourceNames.map(source => sources[source].current);
            const efficiencyValues = sourceNames.map(source => sources[source].efficiency);

            // Format source names properly
            const formattedNames = sourceNames.map(name => {
                switch(name) {
                    case 'oil_gas': return '<b>Oil & Gas</b>';
                    case 'solar': return '<b>Solar</b>';
                    case 'wind': return '<b>Wind</b>';
                    case 'hydrogen': return '<b>Hydrogen</b>';
                    default: return '<b>' + name.charAt(0).toUpperCase() + name.slice(1) + '</b>';
                }
            });

            if (!energySourcesInitialized) {
                // First load - animate from zero values
                const initialData = [{
                    values: sourceNames.map(() => 0), // Start with all zeros
                    labels: formattedNames,
                    type: 'pie',
                    sort: false,
                    textinfo: 'label+percent',
                    texttemplate: '%{label}<br>%{percent}',
                    marker: {
                        colors: ['#FFD700', '#87CEEB', '#32CD32', '#FF6B35'],
                        line: { color: '#FFFFFF', width: 2 }
                    },
                    hovertemplate: '<b>%{label}</b><br>' +
                                  'Output: %{value} MW<br>' +
                                  'Share: %{percent}<br>' +
                                  '<extra></extra>'
                }];

                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(248,249,250,0.5)',
                    margin: { t: 80, b: 60, l: 50, r: 50 },
                    font: { family: 'Segoe UI, Arial, sans-serif', size: 16, weight: 'bold' },
                    showlegend: true,
                    legend: {
                        orientation: 'h',
                        x: 0.5,
                        xanchor: 'center',
                        y: -0.1,
                        font: { size: 14, weight: 'bold' }
                    }
                };

                // Create chart with initial zero values
                Plotly.newPlot('energy-sources-chart', initialData, layout, {
                    responsive: true, 
                    displayModeBar: false
                });
                
            // Animate to final values with longer delay
            setTimeout(() => {
                const steps = 10; // More steps for smoother animation
                let currentStep = 0;
                
                const animateStep = () => {
                    currentStep++;
                    const progress = currentStep / steps;
                    const currentValues = targetValues.map(value => value * progress);
                    
                    const animatedData = {
                        values: [currentValues]
                    };
                    
                    Plotly.restyle('energy-sources-chart', animatedData);
                    
                    if (currentStep < steps) {
                        setTimeout(animateStep, 10); // Slower animation - 80ms per step
                    } else {
                        energySourcesInitialized = true;
                        console.log('Pie chart animation completed');
                    }
                };
                
                animateStep();
            }, 1500); // Longer delay - start after 1.5 seconds

            } else {
                // Subsequent updates - direct update with smooth transition
                const data = [{
                    values: targetValues,
                    labels: formattedNames,
                    type: 'pie',
                    sort: false,
                    textinfo: 'label+percent',
                    texttemplate: '%{label}<br>%{percent}',
                    marker: {
                        colors: ['#FFD700', '#87CEEB', '#32CD32', '#FF6B35'],
                        line: { color: '#FFFFFF', width: 2 }
                    },
                    hovertemplate: '<b>%{label}</b><br>' +
                                  'Output: %{value} MW<br>' +
                                  'Share: %{percent}<br>' +
                                  '<extra></extra>'
                }];
                
                // Smooth update with transition
                Plotly.restyle('energy-sources-chart', { values: [targetValues] }, [0]);
            }
            
            // Store the data for future updates
            window.chartData = { targetValues, formattedNames };
        }

        // Function to update chart with animation when values change
        function updateEnergySourcesChart(newSources) {
            const sourceNames = Object.keys(newSources);
            const newValues = sourceNames.map(source => newSources[source].current);
            
            // Update with smooth animation
            Plotly.restyle('energy-sources-chart', 'values', [newValues]);
        }

        async function loadMaintenanceItems() {
            try {
                const category = document.getElementById('category-filter').value;
                const response = await fetch(`/api/maintenance_items?category=${category}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    maintenanceData = data.maintenance_items;
                    
                    // Only apply live simulation if maintenance updates are enabled
                    if (liveDataEnabled && maintenanceUpdatesEnabled) {
                        simulateMaintenanceChanges(maintenanceData);
                    }
                    
                    displayMaintenanceItems(maintenanceData);
                }
            } catch (error) {
                console.error('Error loading maintenance items:', error);
            }
        }

        function simulateMaintenanceChanges(items) {
            items.forEach(item => {
                // Keep costs static - no dynamic changes to cost
                // Cost will be handled by getStaticCost function
                
                // Gradually change energy impact (slight variation for realism)
                const impactChange = (Math.random() - 0.5) * 0.1; // Reduced variation
                item.energy_impact = Math.max(0, Math.min(15, item.energy_impact + impactChange));
                item.energy_impact = Math.round(item.energy_impact * 10) / 10;
                
                // Occasionally change status (less frequently)
                if (Math.random() < 0.01) { // Reduced from 0.02 to 0.01 for more stability
                    const statuses = ['Pending', 'In Progress', 'Completed'];
                    const currentIndex = statuses.indexOf(item.status);
                    if (currentIndex < statuses.length - 1) {
                        item.status = statuses[currentIndex + 1];
                    }
                }
                
                // Adjust estimated days based on progress (more conservative)
                if (item.status === 'In Progress' && Math.random() < 0.05) {
                    item.estimated_days = Math.max(1, item.estimated_days - 0.05);
                    item.estimated_days = Math.round(item.estimated_days * 10) / 10;
                }
            });
        }

        function displayMaintenanceItems(items) {
            const container = document.getElementById('maintenance-items-container');
            const activeItems = items.filter(item => item.status !== 'Completed');
            
            // Update badge count
            if (document.getElementById('maintenance-count')) {
                document.getElementById('maintenance-count').textContent = activeItems.length + ' Active';
            }

            // Show loading state initially
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading maintenance data...</p>
                    </div>`;
                return;
            }

            // Sort by priority first, then by performance impact (highest first)
            const priorityOrder = { 'Critical': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
            const sortedItems = [...items].sort((a, b) => {
                const aPriority = priorityOrder[a.priority] ?? 4;
                const bPriority = priorityOrder[b.priority] ?? 4;
                
                // If same priority, sort by performance impact (highest first)
                if (aPriority === bPriority) {
                    const aImpact = getPerformanceImpact(a.priority, a.id);
                    const bImpact = getPerformanceImpact(b.priority, b.id);
                    return bImpact - aImpact; // Descending order (highest impact first)
                }
                
                return aPriority - bPriority;
            });

            let html = '';

            sortedItems.forEach(item => {
                const priorityClass = getPriorityClass(item.priority);
                const priorityBadgeClass = getPriorityBadgeClass(item.priority);
                const statusColor = item.status === 'Completed' ? 'success' : 
                                   item.status === 'In Progress' ? 'warning' : 'secondary';

                // Static cost display - no dynamic changes
                const staticCost = getStaticCost(item.id, item.cost);
                
                // Add performance decline reason based on priority
                const declineReason = getPerformanceDeclineReason(item.priority, item.category);

                html += `
                <div class="col-lg-6">
                    <div class="maintenance-item-collapsed ${priorityClass}" onclick="toggleMaintenanceItem(${item.id})" id="maintenance-item-${item.id}">
                        <!-- Collapsed Header -->
                        <div class="maintenance-header">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1 fw-bold">${item.equipment}</h6>
                                        <div class="d-flex flex-wrap gap-1 mb-1">
                                            <span class="badge ${priorityBadgeClass}">${item.priority}</span>
                                            <span class="badge bg-info">${item.category}</span>
                                            <span class="badge bg-${statusColor}">${item.status}</span>
                                        </div>
                                        <small class="text-muted">${declineReason}</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="cost-preview text-danger">-${getPerformanceImpact(item.priority, item.id)}%</div>
                                        <small class="text-muted">Impact</small>
                                        <i class="fas fa-chevron-down maintenance-toggle-icon" id="toggle-icon-${item.id}"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Collapsible Content -->
                        <div class="maintenance-collapse-content" id="collapse-content-${item.id}">
                            <div class="border-top pt-3 mt-2">
                                <p class="text-muted small mb-3">${item.issue}</p>
                                
                                <!-- Performance Impact Indicator -->
                                <div class="alert alert-light border mb-3">
                                    <h6 class="mb-2">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        AI Detection Summary
                                    </h6>
                                    <p class="mb-2 small">${declineReason}</p>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="text-danger fw-bold">-${getAIDetectedDrop(item.priority, item.id)}%</div>
                                            <small class="text-muted">AI Detected Drop</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-warning fw-bold">${item.estimated_days} days</div>
                                            <small class="text-muted">Time to Fix</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-info fw-bold">${getPredictedDecline(item.priority)}%</div>
                                            <small class="text-muted">Further Decline</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Performance Impact Highlight -->
                                <div class="maintenance-cost-highlight">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Performance Impact:</strong>
                                            <span class="h5 mb-0 ms-2 text-danger">-${getPerformanceImpact(item.priority, item.id)}%</span>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted">Efficiency Loss</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Static Details Grid -->
                                <div class="row g-2 mt-2">
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-light rounded">
                                            <div class="small text-muted">Risk Score</div>
                                            <div class="fw-bold text-warning">${getRiskScore(item.priority, item.id)}</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-light rounded">
                                            <div class="small text-muted">Energy Impact</div>
                                            <div class="fw-bold">${item.energy_impact}%</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                            <div>
                                                <div class="small text-muted">Due Date</div>
                                                <div class="fw-bold">${item.due_date} <span class="text-muted small">(${item.estimated_days} days)</span></div>
                                            </div>
                                            <div class="text-end">
                                                <div class="small text-muted">Status</div>
                                                <div class="fw-bold text-${statusColor}">${item.status}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions (Scheduled Options) -->
                                <div class="mt-3 pt-2 border-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">Quick Actions:</small>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); setStatus('${item.id}', 'Scheduled')" title="Mark as Scheduled">
                                                <i class="fas fa-calendar-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); setStatus('${item.id}', 'In Progress')" title="Mark as In Progress">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); setStatus('${item.id}', 'Completed')" title="Mark as Completed">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            
            // Create charts after items are displayed
            createPerformanceDeclineChart();
            updatePriorityChart(sortedItems);
        }

        // Function to return static costs (no dynamic changes)
        function getStaticCost(itemId, originalCost) {
            // Static cost mapping - these never change
            const staticCosts = {
                1: 15000,
                2: 8500,
                3: 22000,
                4: 5500,
                5: 18000,
                6: 12000,
                7: 9500,
                8: 25000
            };
            
            return staticCosts[itemId] || originalCost || 10000;
        }

        // Generate performance decline reason based on AI training data patterns
        function getPerformanceDeclineReason(priority, category) {
            const reasons = {
                'Critical': [
                    'AI detected 18% efficiency drop in last 72 hours - immediate intervention required',
                    'Predictive model shows imminent failure risk based on vibration patterns',
                    'Performance degradation exceeds critical threshold from training data'
                ],
                'High': [
                    'ML analysis shows 12% performance decline trend over 5 days',
                    'Temperature anomaly detected - matches failure patterns from historical data',
                    'Efficiency curve deviating from normal operational parameters'
                ],
                'Medium': [
                    'AI monitoring detected gradual performance decline over 2 weeks',
                    'Predictive maintenance algorithm flagged early warning indicators',
                    'Performance metrics showing signs of potential issues ahead'
                ],
                'Low': [
                    'Routine maintenance based on predictive scheduling algorithm',
                    'Preventive maintenance to avoid predicted performance issues',
                    'Scheduled optimization based on usage pattern analysis'
                ]
            };
            
            const priorityReasons = reasons[priority] || reasons['Low'];
            return priorityReasons[Math.floor(Math.random() * priorityReasons.length)];
        }

        // Get predicted further decline percentage
        function getPredictedDecline(priority) {
            const declines = {
                'Critical': Math.floor(Math.random() * 10) + 15, // 15-25%
                'High': Math.floor(Math.random() * 8) + 8,       // 8-16%
                'Medium': Math.floor(Math.random() * 6) + 4,     // 4-10%
                'Low': Math.floor(Math.random() * 3) + 1         // 1-4%
            };
            
            return declines[priority] || 2;
        }

        // Get performance impact based on priority and equipment ID
        function getPerformanceImpact(priority, itemId) {
            const impactMap = {
                1: { 'Critical': 22.5, 'High': 16.8, 'Medium': 11.2, 'Low': 5.1 },
                2: { 'Critical': 18.9, 'High': 13.4, 'Medium': 8.7, 'Low': 4.2 },
                3: { 'Critical': 25.3, 'High': 19.1, 'Medium': 12.6, 'Low': 6.8 },
                4: { 'Critical': 15.7, 'High': 11.9, 'Medium': 7.3, 'Low': 3.5 },
                5: { 'Critical': 21.4, 'High': 15.6, 'Medium': 10.1, 'Low': 4.9 },
                6: { 'Critical': 19.8, 'High': 14.2, 'Medium': 9.4, 'Low': 4.7 },
                7: { 'Critical': 17.6, 'High': 12.8, 'Medium': 8.1, 'Low': 3.8 },
                8: { 'Critical': 28.2, 'High': 21.7, 'Medium': 14.3, 'Low': 7.9 }
            };
            
            const itemImpacts = impactMap[itemId];
            return itemImpacts ? itemImpacts[priority] || 10.0 : (priority === 'Critical' ? 20.0 : priority === 'High' ? 15.0 : priority === 'Medium' ? 10.0 : 5.0);
        }

        // Get AI detected performance drop (different dataset from performance impact)
        function getAIDetectedDrop(priority, itemId) {
            const aiDropMap = {
                1: { 'Critical': 26.1, 'High': 18.3, 'Medium': 12.7, 'Low': 6.2 },
                2: { 'Critical': 21.7, 'High': 15.8, 'Medium': 10.4, 'Low': 5.1 },
                3: { 'Critical': 29.4, 'High': 22.6, 'Medium': 15.2, 'Low': 8.3 },
                4: { 'Critical': 18.2, 'High': 13.6, 'Medium': 8.9, 'Low': 4.4 },
                5: { 'Critical': 24.8, 'High': 17.9, 'Medium': 11.8, 'Low': 5.9 },
                6: { 'Critical': 23.1, 'High': 16.7, 'Medium': 11.1, 'Low': 5.6 },
                7: { 'Critical': 20.3, 'High': 14.9, 'Medium': 9.7, 'Low': 4.8 },
                8: { 'Critical': 32.6, 'High': 25.4, 'Medium': 17.1, 'Low': 9.5 }
            };
            
            const itemDrops = aiDropMap[itemId];
            return itemDrops ? itemDrops[priority] || 12.0 : (priority === 'Critical' ? 25.0 : priority === 'High' ? 18.0 : priority === 'Medium' ? 12.0 : 6.0);
        }

        // Get risk score based on multiple factors (priority, performance impact, and equipment type)
        function getRiskScore(priority, itemId) {
            const riskScoreMap = {
                1: { 'Critical': 'A1', 'High': 'B2', 'Medium': 'C3', 'Low': 'D4' },
                2: { 'Critical': 'A2', 'High': 'B3', 'Medium': 'C4', 'Low': 'D5' },
                3: { 'Critical': 'A+', 'High': 'A1', 'Medium': 'B2', 'Low': 'C3' },
                4: { 'Critical': 'B1', 'High': 'C2', 'Medium': 'D3', 'Low': 'E4' },
                5: { 'Critical': 'A1', 'High': 'B1', 'Medium': 'C2', 'Low': 'D3' },
                6: { 'Critical': 'A2', 'High': 'B2', 'Medium': 'C3', 'Low': 'D4' },
                7: { 'Critical': 'B1', 'High': 'C1', 'Medium': 'D2', 'Low': 'E3' },
                8: { 'Critical': 'A+', 'High': 'A+', 'Medium': 'A1', 'Low': 'B2' }
            };
            
            const itemRisks = riskScoreMap[itemId];
            return itemRisks ? itemRisks[priority] || 'C1' : (priority === 'Critical' ? 'A1' : priority === 'High' ? 'B2' : priority === 'Medium' ? 'C3' : 'D4');
        }

        // Create performance decline chart showing AI-detected performance drop
        function createPerformanceDeclineChart() {
            // Simulate performance decline data over the last 30 days
            const days = [];
            const expectedPerformance = [];
            const actualPerformance = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toISOString().split('T')[0]);
                
                // Expected performance stays around 92%
                expectedPerformance.push(92 + (Math.random() - 0.5) * 2);
                
                // Actual performance shows decline, especially in last 7 days
                let performance;
                if (i <= 7) {
                    // Sharp decline in last week
                    performance = 85 - (7 - i) * 1.2 + (Math.random() - 0.5) * 3;
                } else if (i <= 14) {
                    // Gradual decline in previous week
                    performance = 88 - (14 - i) * 0.3 + (Math.random() - 0.5) * 2;
                } else {
                    // Normal performance before that
                    performance = 91 + (Math.random() - 0.5) * 2;
                }
                actualPerformance.push(Math.max(65, Math.min(95, performance)));
            }

            const data = [
                {
                    x: days,
                    y: expectedPerformance,
                    name: 'Expected Performance',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#28a745', width: 2, dash: 'dash' },
                    opacity: 0.7
                },
                {
                    x: days,
                    y: actualPerformance,
                    name: 'Actual Performance',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#dc3545', width: 3 },
                    marker: { color: '#dc3545', size: 4 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(220, 53, 69, 0.1)'
                }
            ];

            const layout = {
                title: {
                    text: 'AI-Detected Performance Decline',
                    font: { color: '#323232', size: 14 }
                },
                xaxis: { 
                    title: { text: 'Date', font: { color: '#323232', size: 10 } },
                    tickfont: { color: '#323232', size: 9 }
                },
                yaxis: { 
                    title: { text: 'Performance (%)', font: { color: '#323232', size: 10 } },
                    tickfont: { color: '#323232', size: 9 },
                    range: [70, 100]
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.8)',
                margin: { t: 40, r: 25, l: 40, b: 40 },
                legend: {
                    orientation: 'h',
                    y: -0.2,
                    font: { size: 10 }
                },
                showlegend: true
            };

            Plotly.newPlot('performance-decline-chart', data, layout, {responsive: true, displayModeBar: false});
        }

        // Update priority distribution chart
        function updatePriorityChart(items) {
            const priorityCounts = { 'Critical': 0, 'High': 0, 'Medium': 0 };
            
            items.forEach(item => {
                if (priorityCounts.hasOwnProperty(item.priority)) {
                    priorityCounts[item.priority]++;
                }
            });

            const data = [{
                labels: Object.keys(priorityCounts),
                values: Object.values(priorityCounts),
                type: 'pie',
                marker: {
                    colors: ['#dc3545', '#fd7e14', '#ffc107', '#28a745']
                },
                textinfo: 'label+value',
                textfont: { size: 10 },
                hovertemplate: '<b>%{label}</b><br>Count: %{value}<extra></extra>'
            }];

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 20, r: 20, l: 20, b: 20 },
                showlegend: false,
                font: { size: 10 }
            };

            Plotly.newPlot('priority-distribution-chart', data, layout, {responsive: true, displayModeBar: false});
        }


        function getPriorityClass(priority) {
            switch(priority) {
                case 'Critical': return 'border-danger';
                case 'High': return 'border-warning';
                case 'Medium': return 'border-info';
                default: return 'border-secondary';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'Critical': return 'bg-danger';
                case 'High': return 'bg-warning text-dark';
                case 'Medium': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        function updateMaintenanceStatus(itemId, newStatus) {
            // Show modal instead of using prompt
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            
            // Store the item ID and new status for the modal
            document.getElementById('statusModal').setAttribute('data-item-id', itemId);
            document.getElementById('statusModal').setAttribute('data-new-status', newStatus);
            
            // Update modal content
            const modalBody = document.querySelector('#statusModal .modal-body');
            modalBody.innerHTML = 
                '<p>Update maintenance item to status: <strong>' + newStatus + '</strong></p>' +
                '<div class="form-group">' +
                    '<label for="statusNotes">Notes (optional):</label>' +
                    '<textarea class="form-control" id="statusNotes" rows="3" placeholder="Add any notes about this status change..."></textarea>' +
                '</div>';
            
            modal.show();
        }

        function confirmStatusUpdate() {
            const modal = document.getElementById('statusModal');
            const itemId = modal.getAttribute('data-item-id');
            const newStatus = modal.getAttribute('data-new-status');
            const notes = document.getElementById('statusNotes') ? document.getElementById('statusNotes').value : '';
            
            // Close modal
            bootstrap.Modal.getInstance(modal).hide();
            
            // Show success toast
            showToast('Status Updated', 'Maintenance item updated to ' + newStatus, 'success');
            
            // Only reload if maintenance updates are enabled, otherwise update locally
            if (maintenanceUpdatesEnabled) {
                setTimeout(function() {
                    loadMaintenanceItems();
                }, 500);
            } else {
                // Update the local data without reload
                const item = maintenanceData.find(item => item.id == itemId);
                if (item) {
                    item.status = newStatus;
                    displayMaintenanceItems(maintenanceData);
                }
            }
        }

        // Function to handle status changes from quick action buttons
        async function setStatus(itemId, newStatus) {
            try {
                // Update the item status directly for immediate feedback
                const item = maintenanceData.find(item => item.id == itemId);
                if (item) {
                    item.status = newStatus;
                    
                    // Show success toast with appropriate message
                    let message = '';
                    switch(newStatus) {
                        case 'Scheduled':
                            message = 'Maintenance has been scheduled';
                            break;
                        case 'In Progress':
                            message = 'Maintenance is now in progress';
                            break;
                        case 'Completed':
                            message = 'Maintenance has been completed';
                            break;
                        default:
                            message = 'Maintenance status updated';
                    }
                    
                    showToast('Status Updated', message, 'success');
                    
                    // Update display immediately without refresh
                    displayMaintenanceItems(maintenanceData);
                }
                
                // Try to update via API in the background (optional)
                try {
                    const response = await fetch(`/api/update_maintenance/${itemId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    
                    if (response.ok) {
                        console.log('✅ Status successfully synced with server');
                    } else {
                        console.log('⚠️ Server sync failed, but local update succeeded');
                    }
                } catch (apiError) {
                    console.log('⚠️ API unavailable, but local update succeeded:', apiError);
                }
                
            } catch (error) {
                console.error('❌ Error updating status:', error);
                showToast('Error updating status', 'Please try again', 'error');
            }
        }

        // Function to toggle maintenance item collapse/expand
        function toggleMaintenanceItem(itemId) {
            const collapseContent = document.getElementById(`collapse-content-${itemId}`);
            const toggleIcon = document.getElementById(`toggle-icon-${itemId}`);
            const maintenanceItem = document.getElementById(`maintenance-item-${itemId}`);
            
            if (collapseContent && toggleIcon && maintenanceItem) {
                const isExpanded = collapseContent.classList.contains('show');
                
                if (isExpanded) {
                    // Collapse
                    collapseContent.classList.remove('show');
                    toggleIcon.classList.remove('rotated');
                    maintenanceItem.classList.remove('expanded');
                } else {
                    // Expand
                    collapseContent.classList.add('show');
                    toggleIcon.classList.add('rotated');
                    maintenanceItem.classList.add('expanded');
                }
            }
        }

        function showToast(title, message, type) {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
            
            const toastHtml = 
                '<div id="' + toastId + '" class="toast align-items-center text-white ' + bgClass + ' border-0" role="alert">' +
                    '<div class="d-flex">' +
                        '<div class="toast-body">' +
                            '<strong>' + title + '</strong><br>' + message +
                        '</div>' +
                        '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>' +
                    '</div>' +
                '</div>';
            
            toastContainer.innerHTML = toastHtml;
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        function toggleMaintenanceView() {
            showAllMaintenance = !showAllMaintenance;
            const toggleText = document.getElementById('toggle-text');
            const toggleIcon = document.getElementById('toggle-icon');
            
            if (showAllMaintenance) {
                toggleText.textContent = 'Show Critical';
                toggleIcon.className = 'fas fa-eye-slash';
                displayMaintenanceItems(maintenanceData);
            } else {
                toggleText.textContent = 'Show All';
                toggleIcon.className = 'fas fa-eye';
                const criticalItems = maintenanceData.filter(item => 
                    item.priority === 'Critical' || item.priority === 'High'
                );
                displayMaintenanceItems(criticalItems);
            }
        }

        function filterMaintenance() {
            const priority = document.getElementById('category-filter').value;
            let filteredData = maintenanceData;
            
            if (priority !== 'all') {
                filteredData = maintenanceData.filter(item => item.priority === priority);
            }
            
            // Sort by priority first, then by performance impact (highest first)
            const priorityOrder = { 'Critical': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
            filteredData.sort((a, b) => {
                const aPriority = priorityOrder[a.priority] ?? 4;
                const bPriority = priorityOrder[b.priority] ?? 4;
                
                // If same priority, sort by performance impact (highest first)
                if (aPriority === bPriority) {
                    const aImpact = getPerformanceImpact(a.priority, a.id);
                    const bImpact = getPerformanceImpact(b.priority, b.id);
                    return bImpact - aImpact; // Descending order (highest impact first)
                }
                
                return aPriority - bPriority;
            });
            
            displayMaintenanceItems(filteredData);
            updatePriorityChart(filteredData);
        }

        async function loadUsageHistory() {
            try {
                const days = document.getElementById('history-days').value;
                const response = await fetch(`/api/usage_history?days=${days}`);
                const data = await response.json();
                
                console.log('API Response Data:', data);
                
                if (data.status === 'success') {
                    // Apply live simulation to history data
                    if (liveDataEnabled) {
                        simulateHistoryChanges(data.history, data.summary);
                    }
                    
                    console.log('History after simulation:', data.history);
                    
                    createUsageHistoryChart(data.history);
                    displayHistorySummary(data.summary);
                    
                    // Show the Live Performance section when line chart appears
                    const historySummary = document.getElementById('history-summary');
                    if (historySummary) {
                        historySummary.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading usage history:', error);
            }
        }

        function simulateHistoryChanges(history, summary) {
            // Update the most recent data points to show live changes
            const recentPoints = Math.min(3, history.length);
            
            for (let i = history.length - recentPoints; i < history.length; i++) {
                const point = history[i];
                
                // Simulate realistic power generation changes
                const powerChange = (Math.random() - 0.5) * 20;
                point.power_generated += powerChange;
                point.power_generated = Math.max(600, Math.min(1200, point.power_generated));
                point.power_generated = Math.round(point.power_generated * 10) / 10;
                
                // Simulate clean energy percentage changes
                const cleanChange = (Math.random() - 0.5) * 5;
                point.clean_energy += cleanChange;
                point.clean_energy = Math.max(50, Math.min(95, point.clean_energy));
                point.clean_energy = Math.round(point.clean_energy * 10) / 10;
                
                // Simulate net zero score changes
                const netZeroChange = (Math.random() - 0.5) * 4;
                point.net_zero_score += netZeroChange;
                point.net_zero_score = Math.max(45, Math.min(90, point.net_zero_score));
                point.net_zero_score = Math.round(point.net_zero_score * 10) / 10;
                
                // Maintenance events change occasionally
                if (Math.random() < 0.1) {
                    point.maintenance_events = Math.max(0, point.maintenance_events + (Math.random() > 0.7 ? 1 : -1));
                }
            }
            
            // Update summary with live averages
            summary.avg_power = Math.round(history.reduce((sum, h) => sum + h.power_generated, 0) / history.length * 10) / 10;
            summary.avg_clean = Math.round(history.reduce((sum, h) => sum + h.clean_energy, 0) / history.length * 10) / 10;
            summary.avg_net_zero = Math.round(history.reduce((sum, h) => sum + h.net_zero_score, 0) / history.length * 10) / 10;
            summary.total_maintenance_events = history.reduce((sum, h) => sum + h.maintenance_events, 0);
        }

        function createUsageHistoryChart(history) {
            const dates = history.map(h => h.date);
            
            // Debug: Log the data structure to console
            console.log('Usage History Data:', history);
            console.log('Clean Energy Values:', history.map(h => h.clean_energy));
            
            // Prepare final data arrays
            const powerData = history.map(h => h.power_generated);
            const cleanData = history.map(h => h.clean_energy);
            const netZeroData = history.map(h => h.net_zero_score);
            
            const layout = {
                title: {
                    text: liveDataEnabled ? 'Live Performance Trends ●' : 'Performance Trends',
                    font: { color: '#323232', size: 16 }
                },
                xaxis: { 
                    title: { text: '', font: { color: '#323232', size: 11 } },
                    tickfont: { color: '#323232', size: 10 },
                    showticklabels: true
                },
                yaxis: { 
                    title: { text: 'Power (MW)', font: { color: '#84BD00', size: 11 } },
                    tickfont: { color: '#84BD00', size: 10 },
                    side: 'left'
                },
                yaxis2: {
                    title: { text: 'Percentage (%)', font: { color: '#00A3E0', size: 11 } },
                    tickfont: { color: '#323232', size: 10 },
                    overlaying: 'y',
                    side: 'right',
                    range: [0, 100]
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(248,249,250,0.5)',
                hovermode: 'x unified',
                legend: {
                    font: { color: '#323232', size: 10 },
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.12
                },
                margin: { t: 50, b: 50, l: 50, r: 50 }
            };

            if (!usageHistoryInitialized) {
                // First load - rapid twitchy animation
                const initialData = [
                    {
                        x: [],
                        y: [],
                        name: 'Power (MW)',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#84BD00', width: 2 },
                        marker: { color: '#84BD00', size: 4 },
                        yaxis: 'y1'
                    },
                    {
                        x: [],
                        y: [],
                        name: 'Clean %',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#00A3E0', width: 2 },
                        marker: { color: '#00A3E0', size: 4 },
                        yaxis: 'y2'
                    },
                    {
                        x: [],
                        y: [],
                        name: 'Net Zero %',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#00843D', width: 2 },
                        marker: { color: '#00843D', size: 4 },
                        yaxis: 'y2'
                    }
                ];

                // Create initial empty chart
                Plotly.newPlot('usage-history-chart', initialData, layout, {responsive: true, displayModeBar: false});
                
                // Rapid progressive data animation - start immediately
                const totalPoints = dates.length;
                let currentPoint = 0;
                
                // Store data arrays that we'll build progressively
                const progressiveData = [
                    { x: [], y: [] }, // Power
                    { x: [], y: [] }, // Clean
                    { x: [], y: [] }  // Net Zero
                ];
                
                const addDataPoint = () => {
                    if (currentPoint < totalPoints) {
                        // Add current data point to progressive arrays
                        progressiveData[0].x.push(dates[currentPoint]);
                        progressiveData[0].y.push(powerData[currentPoint]);
                        progressiveData[1].x.push(dates[currentPoint]);
                        progressiveData[1].y.push(cleanData[currentPoint]);
                        progressiveData[2].x.push(dates[currentPoint]);
                        progressiveData[2].y.push(netZeroData[currentPoint]);
                        
                        // Update chart with current progressive data
                        const update = {
                            x: [progressiveData[0].x, progressiveData[1].x, progressiveData[2].x],
                            y: [progressiveData[0].y, progressiveData[1].y, progressiveData[2].y]
                        };
                        
                        Plotly.restyle('usage-history-chart', update);
                        currentPoint++;
                        
                        // Very fast, twitchy delay - rapid succession
                        setTimeout(addDataPoint, 25); // Super fast 25ms intervals for twitchy effect
                    } else {
                        usageHistoryInitialized = true;
                        console.log('Usage history rapid animation completed with', totalPoints, 'data points');
                    }
                };
                
                addDataPoint(); // Start immediately, no initial delay
            } else {
                // Subsequent updates - use Plotly.react for cleaner updates
                const data = [
                    {
                        x: dates,
                        y: powerData,
                        name: 'Power (MW)',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#84BD00', width: 2 },
                        marker: { color: '#84BD00', size: 4 },
                        yaxis: 'y1'
                    },
                    {
                        x: dates,
                        y: cleanData,
                        name: 'Clean %',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#00A3E0', width: 2 },
                        marker: { color: '#00A3E0', size: 4 },
                        yaxis: 'y2'
                    },
                    {
                        x: dates,
                        y: netZeroData,
                        name: 'Net Zero %',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#00843D', width: 2 },
                        marker: { color: '#00843D', size: 4 },
                        yaxis: 'y2'
                    }
                ];
                
                // Use Plotly.react for cleaner updates without jarring
                Plotly.react('usage-history-chart', data, layout, {responsive: true, displayModeBar: false});
            }
        }

        function displayHistorySummary(summary) {
            const container = document.getElementById('summary-stats');
            const liveIndicator = liveDataEnabled ? '<span class="text-success">● LIVE</span>' : '';
            
            container.innerHTML = `
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-success">${summary.avg_power}</div>
                            <small class="text-muted">Avg MW</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-info">${summary.avg_clean}%</div>
                            <small class="text-muted">Clean Energy</small>
                        </div>
                    </div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-primary">${summary.avg_net_zero}%</div>
                            <small class="text-muted">Net Zero</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-warning">${summary.total_maintenance_events}</div>
                            <small class="text-muted">Maintenance</small>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info py-2 px-2 small mb-0">
                    <i class="fas fa-chart-line"></i> ${liveIndicator}
                    ${summary.avg_clean > 70 ? 'Excellent' : 'Good'} performance. 
                    ${summary.total_maintenance_events > 5 ? 'Monitor maintenance.' : 'Optimal frequency.'}
                </div>
            `;
        }

        function updateMaintenanceStatus(itemId) {
            // Create a dropdown modal for status selection
            const modalHtml = `
                <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="statusModalLabel">Update Status</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" onclick="setStatus(${itemId}, 'Pending')">
                                        <i class="fas fa-clock"></i> Pending
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="setStatus(${itemId}, 'In Progress')">
                                        <i class="fas fa-cog fa-spin"></i> In Progress
                                    </button>
                                    <button class="btn btn-outline-success" onclick="setStatus(${itemId}, 'Completed')">
                                        <i class="fas fa-check-circle"></i> Completed
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('statusModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }
        

        
        function showToast(message, type) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            // Add toast
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            // Show toast
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // Remove toast after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Live data simulation variables
        let liveDataEnabled = true;
        let baseEnergyLevel = 87.5;
        let energyTrend = 0.05; // Reduced trend for smoother changes
        let lastUpdateTime = Date.now();
        let simulatedData = {
            solar: { base: 35.2, trend: 0.02, efficiency: 85.1 }, // Reduced trends
            wind: { base: 28.7, trend: -0.015, efficiency: 78.3 },
            hydrogen: { base: 15.6, trend: 0.01, efficiency: 92.1 },
            oil_gas: { base: 20.5, trend: -0.005, efficiency: 67.8 }
        };
        
        // Previous values for stabilization
        let previousValues = {
            total_power: 87.5,
            energy_sources: {
                solar: { current: 35.2, efficiency: 85.1 },
                wind: { current: 28.7, efficiency: 78.3 },
                hydrogen: { current: 15.6, efficiency: 92.1 },
                oil_gas: { current: 20.5, efficiency: 67.8 }
            }
        };

        // Live data simulation function with stabilization
        function simulateLiveData() {
            const now = Date.now();
            const timeDelta = (now - lastUpdateTime) / 1000; // seconds
            lastUpdateTime = now;

            // Simulate energy level changes with smoother transitions
            baseEnergyLevel += energyTrend * timeDelta;
            
            // Keep energy level within realistic bounds
            if (baseEnergyLevel > 95) {
                baseEnergyLevel = 95;
                energyTrend = -Math.abs(energyTrend);
            } else if (baseEnergyLevel < 70) {
                baseEnergyLevel = 70;
                energyTrend = Math.abs(energyTrend);
            }
            
            // Less frequent trend changes for stability
            if (Math.random() < 0.005) { // Reduced from 0.02 to 0.005
                energyTrend *= -1;
            }

            // Simulate energy sources with stable patterns
            Object.keys(simulatedData).forEach(source => {
                const data = simulatedData[source];
                data.base += data.trend * timeDelta;
                
                // Keep values within realistic bounds
                if (data.base > 45) {
                    data.base = 45;
                    data.trend = -Math.abs(data.trend);
                } else if (data.base < 10) {
                    data.base = 10;
                    data.trend = Math.abs(data.trend);
                }
                
                // Efficiency stays stable
                data.efficiency = Math.max(60, Math.min(95, data.efficiency));
            });

            // Calculate new values
            const newTotalPower = Math.round(baseEnergyLevel * 10) / 10;
            const newSources = {
                solar: { 
                    current: Math.round(simulatedData.solar.base * 10) / 10, 
                    capacity: 100, 
                    efficiency: Math.round(simulatedData.solar.efficiency * 10) / 10 
                },
                wind: { 
                    current: Math.round(simulatedData.wind.base * 10) / 10, 
                    capacity: 100, 
                    efficiency: Math.round(simulatedData.wind.efficiency * 10) / 10 
                },
                hydrogen: { 
                    current: Math.round(simulatedData.hydrogen.base * 10) / 10, 
                    capacity: 50, 
                    efficiency: Math.round(simulatedData.hydrogen.efficiency * 10) / 10 
                },
                oil_gas: { 
                    current: Math.round(simulatedData.oil_gas.base * 10) / 10, 
                    capacity: 80, 
                    efficiency: Math.round(simulatedData.oil_gas.efficiency * 10) / 10 
                }
            };

            // Value stabilization: only return new values if they differ significantly from previous ones
            const powerDiff = Math.abs(newTotalPower - previousValues.total_power);
            const shouldUpdate = powerDiff >= 0.2; // Only update if difference is >= 0.2
            
            if (shouldUpdate) {
                // Update previous values
                previousValues.total_power = newTotalPower;
                Object.keys(newSources).forEach(source => {
                    previousValues.energy_sources[source].current = newSources[source].current;
                    previousValues.energy_sources[source].efficiency = newSources[source].efficiency;
                });
                
                return {
                    total_power: newTotalPower,
                    energy_sources: newSources
                };
            } else {
                // Return previous stable values to prevent flickering
                return {
                    total_power: previousValues.total_power,
                    energy_sources: previousValues.energy_sources
                };
            }
        }

        // Enhanced live data loading
        async function loadCurrentStatusLive() {
            try {
                let data;
                if (liveDataEnabled) {
                    // Use simulated live data
                    const simulatedResponse = simulateLiveData();
                    data = { status: 'success', ...simulatedResponse };
                } else {
                    // Use real API data
                    const response = await fetch('/api/energy_sources');
                    data = await response.json();
                }
                
                if (data.status === 'success') {
                    // Update energy bar immediately
                    updateEnergyBar(data.total_power);
                    
                    // Store pie chart data for delayed loading
                    window.energySourcesData = data.energy_sources;
                    
                    // If pie chart is already initialized, update it
                    if (energySourcesInitialized) {
                        createEnergySourcesChart(data.energy_sources);
                    }
                    
                    // Add visual indicator for live data
                    updateLiveDataIndicator();
                }
            } catch (error) {
                console.error('Error loading current status:', error);
                // Fallback to simulated data on error
                if (!liveDataEnabled) {
                    liveDataEnabled = true;
                    loadCurrentStatusLive();
                }
            }
        }

        // Add live data indicator
        function updateLiveDataIndicator() {
            const energyCard = document.querySelector('.col-md-3 .card-header h5');
            if (energyCard && liveDataEnabled) {
                // Add pulsing indicator
                if (!energyCard.querySelector('.live-indicator')) {
                    energyCard.insertAdjacentHTML('beforeend', 
                        ' <span class="live-indicator" style="color: #28a745; font-size: 0.8rem; animation: pulse 2s infinite;">● LIVE</span>'
                    );
                }
            }
        }

        // Auto-refresh with live data simulation - more stable intervals
        let refreshInterval;
        
        // Start with 5 second intervals
        refreshInterval = setInterval(() => {
            loadCurrentStatusLive();
            loadUsageHistory();
            // loadMaintenanceItems(); // Removed - maintenance is now static by default
        }, 5000);
        
        // After 10 seconds, switch to moderate 3 second intervals (not too fast to avoid flickering)
        setTimeout(() => {
            clearInterval(refreshInterval); // Stop the slow interval
            refreshInterval = setInterval(() => {
                loadCurrentStatusLive();
                loadUsageHistory();
                // loadMaintenanceItems(); // Removed - maintenance is now static by default
            }, 2000);
            console.log('Switched to moderate refresh mode (3 second intervals)');
        }, 7000); 

        // Add CSS animation for live indicator
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            .live-toggle {
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 1000;
                background: rgba(0, 163, 224, 0.9);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.8rem;
                cursor: pointer;
            }
        `;
        document.head.appendChild(style);

        // Add toggle button for live data
        const toggleButton = document.createElement('button');
        toggleButton.className = 'live-toggle';
        toggleButton.innerHTML = '● LIVE DATA ON';
        toggleButton.onclick = () => {
            liveDataEnabled = !liveDataEnabled;
            toggleButton.innerHTML = liveDataEnabled ? '● LIVE DATA ON' : '○ LIVE DATA OFF';
            toggleButton.style.background = liveDataEnabled ? 'rgba(0, 163, 224, 0.9)' : 'rgba(108, 117, 125, 0.9)';
        };
        document.body.appendChild(toggleButton);
    </script>
</body>
</html>

