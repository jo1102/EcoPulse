<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Status - EcoPulse Energy Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --aramco-green: #84BD00;
            --aramco-dark-green: #00843D;
            --aramco-blue: #00A3E0;
            --aramco-dark-blue: #0033A0;
            --aramco-white: #FFFFFF;
            --aramco-dark-gray: #323232;
        }
        
        body {
            background: linear-gradient(135deg, #FFFFFF 0%, #F8F9FA 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--aramco-dark-gray);
        }
        
        .navbar {
            background: var(--aramco-white) !important;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--aramco-blue);
        }
        
        .navbar-brand, .navbar-brand:hover {
            color: var(--aramco-dark-gray) !important;
        }
        
        .btn-outline-light {
            color: var(--aramco-blue) !important;
            border-color: var(--aramco-blue) !important;
            font-weight: bold;
        }
        
        .btn-outline-light:hover {
            background-color: var(--aramco-blue) !important;
            border-color: var(--aramco-blue) !important;
            color: white !important;
        }
        
        .card {
            background: var(--aramco-white);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .energy-gauge {
            position: relative;
            width: 80px;
            height: 300px;
            background: #f0f0f0;
            border-radius: 40px;
            margin: 20px auto;
        }
        
        .energy-bar {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 280px;
            background: #e9ecef;
            border-radius: 30px;
            overflow: hidden;
        }
        
        .energy-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(0deg, #28a745 0%, #84BD00 50%, #00A3E0 100%);
            border-radius: 30px;
            transition: height 0.8s ease;
        }
        
        .energy-percentage {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .maintenance-card {
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .maintenance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .live-indicator {
            animation: pulse 2s infinite;
            color: #28a745;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-leaf text-success me-2"></i>
                <strong>EcoPulse Energy Management</strong>
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="btn btn-outline-light me-2" href="/">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-outline-light me-2" href="/current-status">
                            <i class="fas fa-chart-line me-1"></i>Current Status
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-outline-light" href="/future-projection">
                            <i class="fas fa-crystal-ball me-1"></i>Future Projection
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px;">
        <div class="row">
            <div class="col-12">
                <h2 class="text-center mb-4">
                    <i class="fas fa-tachometer-alt text-primary me-2"></i>
                    Current System Status
                </h2>
            </div>
        </div>

        <div class="row">
            <!-- Left Side - Energy Level -->
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header bg-transparent text-center">
                        <h5 class="mb-0">
                            <i class="fas fa-battery-three-quarters text-success"></i>
                            Energy Level
                            <span class="live-indicator">‚óè LIVE</span>
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="energy-gauge">
                            <div class="energy-bar">
                                <div class="energy-fill" id="energy-fill"></div>
                            </div>
                            <div class="energy-percentage" id="energy-percentage">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Charts -->
            <div class="col-md-9">
                <div class="row">
                    <!-- Energy Sources Chart -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie text-info me-2"></i>
                                    Energy Sources Distribution
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="energy-sources-chart" style="height: 400px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Usage History Chart -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0">
                                    <i class="fas fa-history text-warning me-2"></i>
                                    Usage History (Last 30 Days)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="usage-history-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Items -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-tools text-danger me-2"></i>
                            Maintenance Items
                            <span class="badge bg-warning ms-2" id="maintenance-count">Loading...</span>
                        </h5>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="category-filter" onchange="filterMaintenance()">
                            <option value="all">All Categories</option>
                            <option value="Critical">Critical</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Inspection">Inspection</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="maintenance-items-container" class="row g-3">
                            <div class="col-12 text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading maintenance items...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let liveDataEnabled = true;
        let lastUpdateTime = Date.now();
        let maintenanceData = [];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Current Status page loaded, initializing...');
            loadCurrentStatus();
            loadMaintenanceItems();
            loadUsageHistory();
            
            // Auto-refresh every 10 seconds
            setInterval(() => {
                if (liveDataEnabled) {
                    loadCurrentStatus();
                    loadMaintenanceItems();
                    loadUsageHistory();
                }
            }, 10000);
        });

        // Load current status data
        async function loadCurrentStatus() {
            try {
                console.log('Loading current status...');
                const response = await fetch('/api/energy_sources');
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log('Current status loaded successfully');
                    updateEnergyBar(data.total_power);
                    createEnergySourcesChart(data.energy_sources);
                } else {
                    console.error('API returned error:', data);
                }
            } catch (error) {
                console.error('Error loading current status:', error);
                // Show error message to user
                document.getElementById('energy-percentage').textContent = 'Error';
            }
        }

        // Update energy bar
        function updateEnergyBar(percentage) {
            const fill = document.getElementById('energy-fill');
            const percentageText = document.getElementById('energy-percentage');
            
            if (!fill || !percentageText) {
                console.error('Energy bar elements not found');
                return;
            }
            
            console.log(`Updating energy bar to ${percentage}%`);
            
            fill.style.height = percentage + '%';
            percentageText.textContent = percentage + '%';
            
            // Add color coding based on energy level
            if (percentage > 85) {
                fill.style.background = 'linear-gradient(0deg, #28a745 0%, #84BD00 50%, #00A3E0 100%)';
            } else if (percentage > 70) {
                fill.style.background = 'linear-gradient(0deg, #ffc107 0%, #84BD00 50%, #00A3E0 100%)';
            } else {
                fill.style.background = 'linear-gradient(0deg, #dc3545 0%, #fd7e14 50%, #ffc107 100%)';
            }
        }

        // Create energy sources chart
        function createEnergySourcesChart(sources) {
            console.log('Creating energy sources chart...', sources);
            
            const sourceNames = Object.keys(sources);
            const currentValues = sourceNames.map(source => sources[source].current);

            const formattedNames = sourceNames.map(name => {
                switch(name) {
                    case 'oil_gas': return 'Oil & Gas';
                    case 'solar': return 'Solar';
                    case 'wind': return 'Wind';
                    case 'hydrogen': return 'Hydrogen';
                    default: return name.charAt(0).toUpperCase() + name.slice(1);
                }
            });

            const data = [{
                values: currentValues,
                labels: formattedNames,
                type: 'pie',
                textinfo: 'label+percent+value',
                texttemplate: '%{label}<br>%{value} MW<br>%{percent}',
                marker: {
                    colors: ['#FFD700', '#87CEEB', '#32CD32', '#FF6B35'],
                    line: { color: '#FFFFFF', width: 2 }
                },
                hovertemplate: '<b>%{label}</b><br>' +
                              'Output: %{value} MW<br>' +
                              'Share: %{percent}<br>' +
                              '<extra></extra>'
            }];

            const layout = {
                title: 'Energy Sources Distribution',
                font: { family: 'Segoe UI, Arial, sans-serif' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 60, b: 40, l: 40, r: 40 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.1
                }
            };

            Plotly.newPlot('energy-sources-chart', data, layout, {responsive: true, displayModeBar: false});
        }

        // Load maintenance items
        async function loadMaintenanceItems() {
            try {
                console.log('Loading maintenance items...');
                const category = document.getElementById('category-filter').value;
                const response = await fetch(`/api/maintenance_items?category=${category}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log(`Loaded ${data.maintenance_items.length} maintenance items`);
                    maintenanceData = data.maintenance_items;
                    displayMaintenanceItems(maintenanceData);
                } else {
                    console.error('Maintenance API returned error:', data);
                }
            } catch (error) {
                console.error('Error loading maintenance items:', error);
            }
        }

        // Display maintenance items
        function displayMaintenanceItems(items) {
            const container = document.getElementById('maintenance-items-container');
            if (!container) {
                console.error('Maintenance container not found');
                return;
            }
            
            container.innerHTML = '';
            
            // Update maintenance count
            const activeItems = items.filter(item => item.status !== 'Completed');
            const countElement = document.getElementById('maintenance-count');
            if (countElement) {
                countElement.textContent = `${activeItems.length} Active`;
            }
            
            if (items.length === 0) {
                container.innerHTML = '<div class="col-12 text-center"><p class="text-muted">No maintenance items found</p></div>';
                return;
            }
            
            items.forEach(item => {
                const priorityClass = item.priority === 'High' ? 'danger' : 
                                    item.priority === 'Medium' ? 'warning' : 'info';
                
                const statusClass = item.status === 'Completed' ? 'success' :
                                   item.status === 'In Progress' ? 'info' : 'secondary';
                
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="card maintenance-card border-${priorityClass}" style="height: 100%;">
                        <div class="card-body">
                            <h6 class="card-title text-truncate">${item.equipment || 'N/A'}</h6>
                            <p class="card-text small">${item.description || 'No description available'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-${priorityClass} small">${item.priority || 'Unknown'}</span>
                                <span class="badge bg-${statusClass} small">${item.status || 'Unknown'}</span>
                            </div>
                            <div class="mt-2 small text-muted">
                                <i class="fas fa-calendar-alt"></i>
                                ${item.due_date || 'No due date'}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            console.log(`Displayed ${items.length} maintenance items`);
        }

        // Load usage history
        async function loadUsageHistory() {
            try {
                console.log('Loading usage history...');
                const response = await fetch('/api/usage_history?days=30');
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log(`Loaded ${data.history.length} history records`);
                    createUsageHistoryChart(data.history);
                } else {
                    console.error('Usage history API returned error:', data);
                }
            } catch (error) {
                console.error('Error loading usage history:', error);
            }
        }

        // Create usage history chart
        function createUsageHistoryChart(history) {
            console.log('Creating usage history chart...');
            
            const dates = history.map(h => h.date);
            const powerValues = history.map(h => h.power_generated);
            const cleanValues = history.map(h => h.clean_energy);

            const trace1 = {
                x: dates,
                y: powerValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Power Generated (MW)',
                line: { color: '#007bff', width: 3 }
            };

            const trace2 = {
                x: dates,
                y: cleanValues,
                type: 'scatter',
                mode: 'lines',
                name: 'Clean Energy %',
                line: { color: '#28a745', width: 3 },
                yaxis: 'y2'
            };

            const layout = {
                title: 'Power Generation & Clean Energy Trend',
                xaxis: { title: 'Date' },
                yaxis: { 
                    title: 'Power (MW)',
                    titlefont: { color: '#007bff' },
                    tickfont: { color: '#007bff' }
                },
                yaxis2: {
                    title: 'Clean Energy %',
                    titlefont: { color: '#28a745' },
                    tickfont: { color: '#28a745' },
                    overlaying: 'y',
                    side: 'right'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Segoe UI, Arial, sans-serif' },
                showlegend: true
            };

            Plotly.newPlot('usage-history-chart', [trace1, trace2], layout, {responsive: true, displayModeBar: false});
        }

        // Filter maintenance items
        function filterMaintenance() {
            console.log('Filtering maintenance items...');
            loadMaintenanceItems();
        }
    </script>
</body>
</html>